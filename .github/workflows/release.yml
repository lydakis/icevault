name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: IceVault
  TAP_REPO: homebrew-icevault

jobs:
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-14
            arch: arm64
          - runner: macos-15-intel
            arch: x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print toolchain versions
        run: |
          xcodebuild -version
          swift --version

      - name: Resolve release version
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build DMG
        run: |
          ./scripts/build-app.sh \
            --dmg \
            --version "${{ steps.version.outputs.version }}" \
            --arch "${{ matrix.arch }}" \
            --output-dir dist

      - name: Generate checksum
        run: |
          DMG_PATH="dist/${APP_NAME}-${{ steps.version.outputs.version }}-macos-${{ matrix.arch }}.dmg"
          shasum -a 256 "$DMG_PATH" > "dist/${APP_NAME}-${{ matrix.arch }}.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.arch }}
          path: |
            dist/*.dmg
            dist/*.sha256
          if-no-files-found: error

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build-macos

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: dist
          merge-multiple: true

      - name: Build checksum manifest
        run: |
          sort dist/*.sha256 > dist/checksums.txt

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/checksums.txt
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew cask
    runs-on: ubuntu-latest
    needs:
      - build-macos
      - publish-release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: dist
          merge-multiple: true

      - name: Validate tap token
        env:
          TOKEN: ${{ secrets.GORELEASER_TOKEN || secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          if [[ -z "${TOKEN}" ]]; then
            echo "Missing token secret. Set GORELEASER_TOKEN (preferred) or HOMEBREW_TAP_GITHUB_TOKEN." >&2
            exit 1
          fi

      - name: Compute checksums
        id: sums
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ARM_DMG="dist/${APP_NAME}-${VERSION}-macos-arm64.dmg"
          INTEL_DMG="dist/${APP_NAME}-${VERSION}-macos-x86_64.dmg"

          ARM_SHA="$(shasum -a 256 "${ARM_DMG}" | awk '{print $1}')"
          INTEL_SHA="$(shasum -a 256 "${INTEL_DMG}" | awk '{print $1}')"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "arm_sha=${ARM_SHA}" >> "$GITHUB_OUTPUT"
          echo "intel_sha=${INTEL_SHA}" >> "$GITHUB_OUTPUT"

      - name: Clone tap repo
        env:
          TOKEN: ${{ secrets.GORELEASER_TOKEN || secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          git clone "https://x-access-token:${TOKEN}@github.com/${GITHUB_REPOSITORY_OWNER}/${TAP_REPO}.git" tap

      - name: Update cask
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ./scripts/update-homebrew-cask.sh \
            --tap-dir tap \
            --version "${{ steps.sums.outputs.version }}" \
            --repo-owner "${GITHUB_REPOSITORY_OWNER}" \
            --repo-name "${REPO_NAME}" \
            --arm64-sha "${{ steps.sums.outputs.arm_sha }}" \
            --x86_64-sha "${{ steps.sums.outputs.intel_sha }}"

      - name: Commit and push cask update
        run: |
          cd tap

          if [[ -z "$(git status --porcelain -- Casks/icevault.rb)" ]]; then
            echo "No cask changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add Casks/icevault.rb
          git commit -m "Update icevault cask to v${{ steps.sums.outputs.version }}"
          git push origin HEAD:main
