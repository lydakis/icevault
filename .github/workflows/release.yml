name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: IceVault
  TAP_REPO: homebrew-icevault

jobs:
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15
            arch: arm64
          - runner: macos-15-intel
            arch: x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print toolchain versions
        run: |
          xcodebuild -version
          swift --version

      - name: Resolve release version
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Validate signing and notarization secrets
        env:
          APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64 }}
          APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD }}
          APPLE_DEVELOPER_ID_APPLICATION: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
          APP_STORE_CONNECT_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          missing=0
          for key in \
            APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64 \
            APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD \
            APPLE_DEVELOPER_ID_APPLICATION \
            APP_STORE_CONNECT_API_KEY_P8 \
            APP_STORE_CONNECT_KEY_ID \
            APP_STORE_CONNECT_ISSUER_ID
          do
            if [[ -z "${!key}" ]]; then
              echo "Missing required secret: ${key}" >&2
              missing=1
            fi
          done
          if [[ "${missing}" -ne 0 ]]; then
            exit 1
          fi

      - name: Import Developer ID certificate
        env:
          APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64 }}
          APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD }}
        run: |
          CERT_PATH="${RUNNER_TEMP}/icevault-signing-cert.p12"
          KEYCHAIN_PATH="${RUNNER_TEMP}/icevault-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          printf '%s' "${APPLE_DEVELOPER_ID_CERTIFICATE_P12_BASE64}" | base64 -D > "${CERT_PATH}"

          security create-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security set-keychain-settings -lut 21600 "${KEYCHAIN_PATH}"
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security import "${CERT_PATH}" \
            -k "${KEYCHAIN_PATH}" \
            -P "${APPLE_DEVELOPER_ID_CERTIFICATE_PASSWORD}" \
            -A \
            -t cert \
            -f pkcs12
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "${KEYCHAIN_PASSWORD}" \
            "${KEYCHAIN_PATH}"

          security list-keychains -d user -s "${KEYCHAIN_PATH}"
          security default-keychain -d user -s "${KEYCHAIN_PATH}"
          security find-identity -v -p codesigning "${KEYCHAIN_PATH}"

          {
            echo "ICEVAULT_BUILD_KEYCHAIN_PATH=${KEYCHAIN_PATH}"
            echo "ICEVAULT_BUILD_KEYCHAIN_PASSWORD=${KEYCHAIN_PASSWORD}"
          } >> "${GITHUB_ENV}"

      - name: Write App Store Connect API key file
        id: asc_key
        env:
          APP_STORE_CONNECT_API_KEY_P8: ${{ secrets.APP_STORE_CONNECT_API_KEY_P8 }}
        run: |
          ASC_KEY_PATH="${RUNNER_TEMP}/app-store-connect-key.p8"
          printf '%b' "${APP_STORE_CONNECT_API_KEY_P8}" > "${ASC_KEY_PATH}"
          chmod 600 "${ASC_KEY_PATH}"
          echo "path=${ASC_KEY_PATH}" >> "${GITHUB_OUTPUT}"

      - name: Build DMG
        env:
          ICEVAULT_SIGN_IDENTITY: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
          ICEVAULT_NOTARIZE: "1"
          ICEVAULT_ASC_API_KEY_PATH: ${{ steps.asc_key.outputs.path }}
          ICEVAULT_ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ICEVAULT_ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          ./scripts/build-app.sh \
            --dmg \
            --notarize \
            --version "${{ steps.version.outputs.version }}" \
            --arch "${{ matrix.arch }}" \
            --output-dir dist

      - name: Generate checksum
        run: |
          DMG_PATH="dist/${APP_NAME}-${{ steps.version.outputs.version }}-macos-${{ matrix.arch }}.dmg"
          shasum -a 256 "$DMG_PATH" > "dist/${APP_NAME}-${{ matrix.arch }}.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.arch }}
          path: |
            dist/*.dmg
            dist/*.sha256
          if-no-files-found: error

      - name: Cleanup signing keychain
        if: always()
        run: |
          if [[ -n "${ICEVAULT_BUILD_KEYCHAIN_PATH:-}" ]]; then
            security delete-keychain "${ICEVAULT_BUILD_KEYCHAIN_PATH}" || true
          fi

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build-macos

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: dist
          merge-multiple: true

      - name: Build checksum manifest
        run: |
          sort dist/*.sha256 > dist/checksums.txt

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.dmg
            dist/checksums.txt
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew cask
    runs-on: ubuntu-latest
    needs:
      - build-macos
      - publish-release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: dist
          merge-multiple: true

      - name: Validate tap token
        env:
          TOKEN: ${{ secrets.GORELEASER_TOKEN || secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          if [[ -z "${TOKEN}" ]]; then
            echo "Missing token secret. Set GORELEASER_TOKEN (preferred) or HOMEBREW_TAP_GITHUB_TOKEN." >&2
            exit 1
          fi

      - name: Compute checksums
        id: sums
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ARM_DMG="dist/${APP_NAME}-${VERSION}-macos-arm64.dmg"
          INTEL_DMG="dist/${APP_NAME}-${VERSION}-macos-x86_64.dmg"

          ARM_SHA="$(shasum -a 256 "${ARM_DMG}" | awk '{print $1}')"
          INTEL_SHA="$(shasum -a 256 "${INTEL_DMG}" | awk '{print $1}')"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "arm_sha=${ARM_SHA}" >> "$GITHUB_OUTPUT"
          echo "intel_sha=${INTEL_SHA}" >> "$GITHUB_OUTPUT"

      - name: Clone tap repo
        env:
          TOKEN: ${{ secrets.GORELEASER_TOKEN || secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
        run: |
          git clone "https://x-access-token:${TOKEN}@github.com/${GITHUB_REPOSITORY_OWNER}/${TAP_REPO}.git" tap

      - name: Update cask
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ./scripts/update-homebrew-cask.sh \
            --tap-dir tap \
            --version "${{ steps.sums.outputs.version }}" \
            --repo-owner "${GITHUB_REPOSITORY_OWNER}" \
            --repo-name "${REPO_NAME}" \
            --arm64-sha "${{ steps.sums.outputs.arm_sha }}" \
            --x86_64-sha "${{ steps.sums.outputs.intel_sha }}"

      - name: Commit and push cask update
        run: |
          cd tap

          if [[ -z "$(git status --porcelain -- Casks/icevault.rb)" ]]; then
            echo "No cask changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add Casks/icevault.rb
          git commit -m "Update icevault cask to v${{ steps.sums.outputs.version }}"
          git push origin HEAD:main
